<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Quản Lý On/Off Duty & Lương</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .glow { box-shadow: 0 0 20px rgba(102, 126, 234, 0.6); }
    .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="text-gray-800">

  <div class="container mx-auto p-6 max-w-7xl">
    <div class="text-center mb-8">
      <h1 class="text-5xl font-black text-white drop-shadow-lg flex items-center justify-center gap-4">
        <i data-lucide="shield-check" class="w-14 h-14"></i>
        QUẢN LÝ ON/OFF DUTY & LƯƠNG
      </h1>
      <p class="text-xl text-white mt-3">Chào Admin <span class="font-bold text-yellow-300"><%= currentUser?.displayName || 'Admin' %></span></p>
    </div>

    <!-- Thống kê nhanh -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-10">
      <div class="card p-8 rounded-2xl text-center glow">
        <div class="text-5xl font-black text-green-600"><%= stats.onDuty %></div>
        <p class="text-green-700 font-bold">Đang On Duty</p>
      </div>
      <div class="card p-8 rounded-2xl text-center glow">
        <div class="text-5xl font-black text-gray-700"><%= stats.offToday %></div>
        <p class="text-gray-600 font-bold">Đã Off hôm nay</p>
      </div>
      <div class="card p-8 rounded-2xl text-center glow">
        <div class="text-5xl font-black text-red-600"><%= stats.notStarted %></div>
        <p class="text-red-700 font-bold">Chưa vào ca</p>
      </div>
      <div class="card p-8 rounded-2xl text-center glow">
        <div class="text-5xl font-black text-purple-600"><%= users.length %></div>
        <p class="text-purple-700 font-bold">Tổng thành viên</p>
      </div>
    </div>

    <!-- Nút xuất Excel -->
    <div class="text-center mb-10">
      <a href="/export-salary-excel" class="inline-flex items-center gap-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold text-2xl py-5 px-12 rounded-full shadow-2xl transform hover:scale-105 transition">
        <i data-lucide="file-spreadsheet" class="w-10 h-10"></i>
        XUẤT FILE EXCEL LƯƠNG TOÀN SERVER
      </a>
    </div>

    <!-- Bảng danh sách -->
    <div class="card rounded-3xl shadow-2xl overflow-hidden">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6">
        <h2 class="text-3xl font-bold text-center">Danh sách nhân viên - <%= new Date().toLocaleDateString('vi-VN') %></h2>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-4 text-left font-bold text-gray-700">ID</th>
              <th class="px-6 py-4 text-left font-bold text-gray-700">Họ tên</th>
              <th class="px-6 py-4 text-left font-bold text-gray-700">Chức vụ</th>
              <th class="px-6 py-4 text-center font-bold text-gray-700">Trạng thái</th>
              <th class="px-6 py-4 text-center font-bold text-gray-700">Hành động</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% users.forEach(user => { %>
              <% 
                const today = new Date().toLocaleDateString('vi-VN');
                const todayRecord = (user.attendance || []).find(a => a.date === today);
                const isOnDuty = todayRecord && !todayRecord.offTime;
                const onTime = todayRecord?.onTime?.split(' - ')[0] || '-';
                const offTime = todayRecord?.offTime?.split(' - ')[0] || '-';
              %>
              <tr class="hover:bg-purple-50 transition">
                <td class="px-6 py-4 font-bold">#<%= user.id %></td>
                <td class="px-6 py-4 font-bold text-purple-700"><%= user.displayName %></td>
                <td class="px-6 py-4"><%= user.position %> <%= user.rank || '' %></td>
                <td class="px-6 py-4 text-center">
                  <% if (isOnDuty) { %>
                    <span class="flex items-center justify-center gap-2 text-green-600 font-bold">
                      <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                      ĐANG ON DUTY
                    </span>
                    <small class="text-green-600">Từ <%= onTime %></small>
                  <% } else if (todayRecord) { %>
                    <span class="text-gray-600 font-bold">ĐÃ OFF</span>
                    <small class="text-gray-500">Lúc <%= offTime %></small>
                  <% } else { %>
                    <span class="text-red-600 font-bold">CHƯA VÀO CA</span>
                  <% } %>
                </td>
                <td class="px-6 py-4 text-center space-x-3">
                  <!-- Nút On Duty -->
                  <% if (!isOnDuty && !todayRecord) { %>
                    <button onclick="toggleDuty('<%= user.id %>', 'on')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-xl font-bold shadow-lg transform hover:scale-110 transition">
                      <i data-lucide="log-in" class="w-5 h-5 inline"></i> On Duty
                    </button>
                  <% } %>

                  <!-- Nút Off Duty (chỉ hiện khi đang On) -->
                  <% if (isOnDuty) { %>
                    <button onclick="toggleDuty('<%= user.id %>', 'off')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-5 py-3 rounded-xl font-bold shadow-lg transform hover:scale-110 transition">
                      <i data-lucide="log-out" class="w-5 h-5 inline"></i> Off Duty
                    </button>
                  <% } %>

                  <!-- Nút Xem lịch sử -->
                  <button onclick="openHistory('<%= user.id %>', '<%= user.displayName %>')" 
                          class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-xl font-bold shadow-lg transform hover:scale-110 transition">
                    <i data-lucide="history" class="w-5 h-5 inline"></i> Lịch sử
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="text-center mt-10">
      <a href="/home" class="text-white hover:underline mr-8">Trang chủ</a>
      <a href="/logout" onclick="return confirm('Đăng xuất?')" class="text-red-300 hover:text-red-100 font-bold">Đăng xuất</a>
    </div>
  </div>

  <!-- Modal Lịch sử + Tổng lương -->
  <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-5">
    <div class="card rounded-3xl shadow-3xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 flex justify-between items-center">
        <h3 class="text-3xl font-bold" id="modalName">Lịch sử chấm công</h3>
        <button onclick="closeModal()" class="text-white hover:bg-white/20 p-2 rounded-full"><i data-lucide="x" class="w-8 h-8"></i></button>
      </div>
      <div id="modalBody" class="p-8 overflow-y-auto max-h-96">
        <div class="text-center py-16">
          <i data-lucide="loader-2" class="w-16 h-16 animate-spin text-purple-600"></i>
          <p class="text-xl text-gray-600 mt-4">Đang tải lịch sử...</p>
        </div>
      </div>
      <div class="bg-gradient-to-r from-purple-700 to-pink-700 text-white p-8 text-center">
        <p class="text-2xl opacity-90">Tổng lương cá nhân</p>
        <p class="text-6xl font-black text-yellow-300 drop-shadow-lg" id="totalSalary">0 ₫</p>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();

    // Mở modal lịch sử
    function openHistory(userId, userName) {
      document.getElementById('modalName').textContent = `Lịch sử - ${userName}`;
      document.getElementById('modalBody').innerHTML = `<div class="text-center py-16"><i data-lucide="loader-2" class="w-16 h-16 animate-spin text-purple-600"></i><p class="text-xl mt-4">Đang tải...</p></div>`;
      document.getElementById('historyModal').classList.remove('hidden');

      fetch(`/admin/history/${userId}`)
        .then(r => r.json())
        .then(data => {
          let html = '';
          let total = 0;

          if (data.history && data.history.length > 0) {
            data.history.forEach(r => {
              total += r.salary || 0;
              html += `
                <div class="flex justify-between items-center p-5 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl mb-4 shadow">
                  <div>
                    <div class="font-bold text-lg">${r.date}</div>
                    <div class="text-sm text-gray-600">${r.onTime} → ${r.offTime || 'Đang làm'}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold text-green-600">+${(r.salary||0).toLocaleString()}₫</div>
                    <div class="text-sm">${r.hours.toFixed(2)} giờ</div>
                  </div>
                </div>`;
            });
          } else {
            html = `<div class="text-center py-20 text-gray-400"><i data-lucide="clock" class="w-32 h-32 opacity-30"></i><p class="text-2xl mt-6">Chưa có lịch sử</p></div>`;
          }

          document.getElementById('modalBody').innerHTML = html;
          document.getElementById('totalSalary').textContent = total.toLocaleString() + ' ₫';
          lucide.createIcons();
        });
    }

    function closeModal() {
      document.getElementById('historyModal').classList.add('hidden');
    }

    // Bấm On/Off Duty
    function toggleDuty(userId, action) {
      if (!confirm(`Bạn có chắc muốn ${action === 'on' ? 'CHO PHÉP' : 'TẮT'} On Duty của thành viên này?`)) return;

      fetch(`/admin/toggle-${action}/${userId}`, { method: 'POST' })
        .then(() => location.reload());
    }

    // Tự động cập nhật mỗi 5s
    setInterval(() => location.reload(), 5000);
  </script>
</body>
</html>